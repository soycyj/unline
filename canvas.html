<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Unline Canvas</title>
  <style>
    :root{
      --bg:#0b0d10;
      --panel:rgba(20,24,33,0.92);
      --line:rgba(39,48,68,0.9);
      --text:#e8eef9;
      --muted:#a9b4c7;
      --btn:#1f6feb;
      --btn2:#2b3242;
      --danger:#ef4444;
      --ok:#22c55e;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto;
      display:flex;
      flex-direction:column;
      min-height:100%;
    }
    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background:rgba(10,12,16,0.6);
      backdrop-filter: blur(6px);
      position:sticky;
      top:0;
      z-index:20;
    }
    .left, .right{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(20,24,33,0.6);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .pill strong{color:var(--text);font-weight:900}
    .status{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;
      font-weight:900;
    }
    .online{color:#052e12;background:rgba(34,197,94,0.18);border-color:rgba(34,197,94,0.4)}
    .offline{color:#450a0a;background:rgba(239,68,68,0.16);border-color:rgba(239,68,68,0.35)}

    button{
      padding:9px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      cursor:pointer;
      color:var(--text);
      background:var(--btn2);
      font-weight:900;
      font-size:13px;
      -webkit-tap-highlight-color: transparent;
    }
    button.primary{background:var(--btn);border-color:rgba(31,111,235,0.7)}
    button.danger{background:rgba(239,68,68,0.12);border-color:rgba(239,68,68,0.35);color:#fecaca}
    button.ghost{background:transparent}
    button:disabled{opacity:0.55;cursor:not-allowed}

    input{
      padding:9px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(10,12,16,0.55);
      color:var(--text);
      font-weight:900;
      font-size:13px;
      outline:none;
      width:160px;
    }
    select{
      padding:9px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(10,12,16,0.55);
      color:var(--text);
      font-weight:900;
      font-size:13px;
      outline:none;
    }

    .wrap{
      flex:1;
      display:grid;
      grid-template-columns:260px 1fr 340px;
      gap:12px;
      padding:12px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .stage{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      position:relative;
      min-height:360px;
    }
    canvas{
      width:100%;
      height:100%;
      display:block;
      touch-action:none;
      background:rgba(10,12,16,0.55);
    }

    .col{display:flex;flex-direction:column;gap:12px}
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
    }
    .card h3{
      margin:0 0 10px;
      font-size:13px;
      color:var(--muted);
      font-weight:900;
      text-transform:uppercase;
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .small{font-size:12px;color:var(--muted);line-height:1.55;margin:8px 0 0}

    .swatches{display:flex;gap:8px;flex-wrap:wrap}
    .swatch{
      width:24px;height:24px;border-radius:8px;
      border:1px solid var(--line);
      cursor:pointer;
      outline:none;
    }
    .swatch.active{
      border-color:rgba(232,238,249,0.95);
      box-shadow:0 0 0 2px rgba(232,238,249,0.25) inset;
    }

    .banner{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(245,158,11,0.35);
      background:rgba(245,158,11,0.10);
      color:#fde68a;
      font-size:12px;
      line-height:1.55;
      display:none;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .urow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(10,12,16,0.45);
    }
    .uleft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .dot{
      width:12px;height:12px;border-radius:99px;
      border:1px solid rgba(255,255,255,0.25);
      flex:0 0 auto;
    }
    .uname{
      font-size:13px;
      font-weight:900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .utags{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .tag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background:rgba(20,24,33,0.55);
      white-space:nowrap;
    }
    .tag.ok{border-color:rgba(34,197,94,0.45); color:#bbf7d0; background:rgba(34,197,94,0.12)}
    .tag.warn{border-color:rgba(245,158,11,0.45); color:#fde68a; background:rgba(245,158,11,0.10)}
    .tag.bad{border-color:rgba(239,68,68,0.45); color:#fecaca; background:rgba(239,68,68,0.10)}

    .modalWrap{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modal{
      width:min(520px, 94vw);
      background:rgba(20,24,33,0.96);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
    }
    .modal h2{
      margin:0 0 8px;
      font-size:16px;
      font-weight:900;
    }
    .modal p{
      margin:0 0 14px;
      color:var(--muted);
      font-size:13px;
      line-height:1.6;
    }
    .modal .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    @media (max-width:1060px){
      .wrap{grid-template-columns:1fr}
      input{width:140px}
      .stage{min-height:420px}
    }
    @media (max-width:520px){
      button{ padding:12px 14px; border-radius:14px; }
      input, select{ padding:12px 14px; border-radius:14px; }
      .wrap{ padding:10px; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="left">
      <div id="connStatus" class="status offline">Offline</div>
      <div class="pill">Room <strong id="roomTxt"></strong></div>
      <div class="pill">Role <strong id="roleTxt">Viewer</strong></div>
      <div class="pill">Visitors <strong id="visitorsTxt">0</strong></div>
      <div id="trialPill" class="pill" style="display:none">Trial ends in <strong id="trialCountdown">10:00</strong></div>
    </div>
    <div class="right">
      <input id="roomInput" placeholder="Room code" />
      <button id="goRoomBtn">Go</button>
      <button id="clearBtn" class="danger">Clear</button>
    </div>
  </div>

  <div class="wrap">
    <div class="col">
      <div class="card">
        <h3>Tools</h3>
        <div class="row">
          <button id="toolPen">Pen</button>
          <button id="toolEraser">Eraser</button>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="swatches" id="swatches"></div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="small">Size</div>
          <select id="sizeSel">
            <option value="2">2</option>
            <option value="3" selected>3</option>
            <option value="5">5</option>
            <option value="8">8</option>
            <option value="12">12</option>
          </select>
        </div>

        <div class="banner" id="viewerBanner">
          Viewer 모드입니다. Participant만 그리기와 음성을 사용할 수 있습니다.
        </div>

        <div class="banner" id="lobbyBanner">
          Trial은 Participant 2명이 Ready를 누른 뒤 시작됩니다.
        </div>

        <div class="banner" id="turnBanner">
          모바일에서 연결이 불안정하면 TURN 설정이 필요합니다. /api/ice에 TURN을 넣어주세요.
        </div>

        <p class="small" id="toolInfo"></p>
      </div>

      <div class="card" id="ownerPanel" style="display:none">
        <h3>Permissions</h3>
        <p class="small">첫 입장자만 이 패널이 보입니다. 체크로 Participant를 지정하세요. 최대 2명입니다.</p>
        <div class="list" id="rosterList"></div>
      </div>
    </div>

    <div class="stage">
      <canvas id="board"></canvas>
    </div>

    <div class="col">
      <div class="card">
        <h3>Trial</h3>
        <div class="row">
          <button id="readyBtn" class="primary" disabled>Ready</button>
          <button id="unreadyBtn" class="ghost" disabled>Not ready</button>
        </div>
        <p class="small" id="readyHint"></p>
      </div>

      <div class="card">
        <h3>Voice</h3>
        <div class="row">
          <button class="primary" id="startVoiceBtn" disabled>Start voice</button>
          <button id="enableAudioBtn">Enable audio</button>
          <button class="danger" id="stopVoiceBtn" disabled>Stop</button>
        </div>
        <p class="small" id="voiceState">Idle</p>
        <audio id="remoteAudio" autoplay playsinline></audio>
        <p class="small" id="voiceHint"></p>
        <p class="small" id="rtcDbg"></p>
      </div>
    </div>
  </div>

  <div class="modalWrap" id="decisionModal">
    <div class="modal">
      <h2>Trial ended</h2>
      <p>학생이 Continue 여부를 선택합니다.</p>
      <div class="actions">
        <button class="primary" id="btnContinue">Continue with this coach</button>
        <button id="btnRetry">Try another coach</button>
        <button class="danger" id="btnEnd">End here</button>
      </div>
      <p class="small" id="decisionHint"></p>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function setConn(online){
      const el = $("connStatus");
      if(online){
        el.textContent = "Online";
        el.classList.remove("offline");
        el.classList.add("online");
      }else{
        el.textContent = "Offline";
        el.classList.remove("online");
        el.classList.add("offline");
      }
    }

    const qs = new URLSearchParams(location.search);
    let room = (qs.get("room") || "").trim() || "TEST";

    let clientId = (qs.get("clientId") || "").trim();
    if(!clientId){
      const key = `unline_auto_clientId_${room}`;
      clientId = localStorage.getItem(key) || ("c" + Math.random().toString(16).slice(2,10));
      localStorage.setItem(key, clientId);
    }

    // label is display only, not authority
    const label = (qs.get("label") || "").trim().toLowerCase();

    $("roomTxt").textContent = room;
    $("roomInput").value = room;

    let ws = null;

    let self = { clientId, shortId: clientId.slice(0,6), color:"#E8EEF9", role:"Viewer", ready:false, isOwner:false };
    let roster = [];

    let sessionMode = "lobby";
    let trialEndsAt = null;
    let trialTick = null;
    let trialEndedUiShown = false;

    function canDraw(){ return self.role === "Participant" && sessionMode !== "trial_ended"; }
    function canVoice(){ return self.role === "Participant" && sessionMode !== "trial_ended"; }

    function setRtcDbg(t){ $("rtcDbg").textContent = t || ""; }

    function buildWsUrl(){
      const wsProto = (location.protocol === "https:") ? "wss" : "ws";
      return `${wsProto}://${location.host}/ws?room=${encodeURIComponent(room)}&clientId=${encodeURIComponent(clientId)}`;
    }

    function send(type, data = {}){
      if(!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type, ...data }));
    }

    function startTrialCountdown(){
      if(trialTick) clearInterval(trialTick);
      if(!trialEndsAt) return;

      $("trialPill").style.display = "inline-flex";

      const tick = () => {
        const ms = trialEndsAt - Date.now();
        if(ms <= 0){
          $("trialCountdown").textContent = "00:00";
          if(trialTick) clearInterval(trialTick);
          trialTick = null;
          return;
        }
        const s = Math.floor(ms / 1000);
        const mm = String(Math.floor(s / 60)).padStart(2,"0");
        const ss = String(s % 60).padStart(2,"0");
        $("trialCountdown").textContent = `${mm}:${ss}`;
      };

      tick();
      trialTick = setInterval(tick, 250);
    }

    function stopTrialCountdown(){
      if(trialTick) clearInterval(trialTick);
      trialTick = null;
      $("trialPill").style.display = "none";
    }

    function updateUi(){
      $("roleTxt").textContent = self.role;
      $("visitorsTxt").textContent = String(roster.length);

      $("viewerBanner").style.display = (self.role !== "Participant") ? "block" : "none";
      $("lobbyBanner").style.display = (sessionMode === "lobby") ? "block" : "none";

      // Owner panel
      $("ownerPanel").style.display = self.isOwner ? "block" : "none";
      renderRoster();

      // Ready buttons only for participant and only in lobby
      const canReady = (self.role === "Participant" && sessionMode === "lobby");
      $("readyBtn").disabled = !canReady || self.ready;
      $("unreadyBtn").disabled = !canReady || !self.ready;
      $("readyHint").textContent =
        sessionMode === "trial"
          ? "Trial 진행 중입니다"
          : (sessionMode === "trial_ended" ? "Trial 종료" : "Participant 2명이 Ready일 때 Trial이 시작됩니다");

      // Voice UI
      $("startVoiceBtn").disabled = !(canVoice() && sessionMode !== "lobby") || callActive;
      $("stopVoiceBtn").disabled = !callActive;

      if(sessionMode === "trial"){
        if(trialEndsAt) startTrialCountdown();
      } else {
        stopTrialCountdown();
      }

      // Decision modal is shown only when server says trial_ended
      if(sessionMode !== "trial_ended"){
        if(!trialEndedUiShown) $("decisionModal").style.display = "none";
      }

      // Label hint only
      if(label === "teacher" || label === "student") {
        // intentionally not shown as role, keeps server role clean
      }
    }

    function renderRoster(){
      const box = $("rosterList");
      if(!self.isOwner){ box.textContent = ""; return; }

      box.textContent = "";
      for(const u of roster){
        const row = document.createElement("div");
        row.className = "urow";

        const left = document.createElement("div");
        left.className = "uleft";

        const dot = document.createElement("div");
        dot.className = "dot";
        dot.style.background = u.color;

        const name = document.createElement("div");
        name.className = "uname";
        name.textContent = u.shortId;

        left.appendChild(dot);
        left.appendChild(name);

        const right = document.createElement("div");
        right.className = "utags";

        const roleTag = document.createElement("span");
        roleTag.className = "tag " + (u.role === "Participant" ? "ok" : "warn");
        roleTag.textContent = u.role;

        const readyTag = document.createElement("span");
        readyTag.className = "tag " + (u.ready ? "ok" : "warn");
        readyTag.textContent = u.ready ? "Ready" : "Not ready";

        const ownerTag = document.createElement("span");
        ownerTag.className = "tag";
        ownerTag.textContent = u.isOwner ? "Owner" : "";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = (u.role === "Participant");
        cb.style.transform = "scale(1.1)";
        cb.title = "Participant 지정";
        cb.addEventListener("change", () => {
          send("set_participant", { targetId: u.clientId, allow: cb.checked });
        });

        // Disable if already 2 participants and this user is not currently participant
        const participantCount = roster.filter(x => x.role === "Participant").length;
        if(participantCount >= 2 && u.role !== "Participant") cb.disabled = true;

        right.appendChild(cb);
        right.appendChild(roleTag);
        right.appendChild(readyTag);
        if(u.isOwner) right.appendChild(ownerTag);

        row.appendChild(left);
        row.appendChild(right);
        box.appendChild(row);
      }
    }

    // Canvas
    const swatchColors = ["#E8EEF9","#22C55E","#3B82F6","#A855F7","#F59E0B","#EF4444","#14B8A6","#F472B6"];
    let tool = "pen";
    let penColor = swatchColors[0];
    let penWidth = 3;

    const canvas = $("board");
    const ctx = canvas.getContext("2d");

    function resize(){
      const rect = canvas.getBoundingClientRect();
      const dpr = Math.max(1, window
