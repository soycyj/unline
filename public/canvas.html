<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>unline</title>
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --line:#e6eaf2;
      --text:#0b1220;
      --muted:#5a677f;
      --btn:#2563eb;
      --btn2:#0f172a;
      --danger:#ef4444;
      --shadow: 0 14px 44px rgba(15,23,42,0.10);
      --radius:20px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 18% 10%, #eaf2ff 0%, rgba(234,242,255,0) 60%),
        radial-gradient(900px 520px at 82% 0%, #f1ecff 0%, rgba(241,236,255,0) 55%),
        var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto;
      display:flex;
      flex-direction:column;
      min-height:100%;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,0.72);
      backdrop-filter: blur(10px);
      position:sticky;
      top:0;
      z-index:20;
    }
    .left,.right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:950;
      letter-spacing:-0.02em;
    }
    .roomLine{
      color:var(--muted);
      font-weight:900;
      font-size:13px;
      letter-spacing:-0.01em;
      white-space:nowrap;
    }

    button{
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      cursor:pointer;
      color:var(--text);
      background:#f2f5fb;
      font-weight:950;
      font-size:13px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
      -webkit-tap-highlight-color: transparent;
    }
    button.primary{
      background:var(--btn);
      border-color:rgba(37,99,235,0.25);
      color:#fff;
    }
    button.danger{
      background:rgba(239,68,68,0.08);
      border-color:rgba(239,68,68,0.25);
      color:#b91c1c;
    }
    button:disabled{opacity:0.55;cursor:not-allowed}

    input{
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fbfcff;
      color:var(--text);
      font-weight:900;
      font-size:13px;
      outline:none;
      width:170px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
    }
    input[type="color"]{
      width:44px;
      height:40px;
      padding:0;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fbfcff;
    }
    input[type="range"]{
      width:140px;
      accent-color: var(--btn);
    }

    .wrap{
      flex:1;
      display:grid;
      grid-template-columns:280px 1fr;
      gap:14px;
      padding:14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .col{display:flex;flex-direction:column;gap:14px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow);
    }
    .card h3{
      margin:0 0 12px;
      font-size:12px;
      color:var(--muted);
      font-weight:950;
      letter-spacing:0.08em;
      text-transform:uppercase;
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .stage{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
      min-height:560px;
    }
    canvas{
      width:100%;
      height:100%;
      display:block;
      touch-action:none;
      background:#ffffff;
    }

    .userRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:#fbfcff;
      margin-top:10px;
    }
    .badge{
      width:12px;height:12px;border-radius:6px;border:1px solid var(--line);
    }
    .meta{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      line-height:1.55;
      margin-top:10px;
      white-space:pre-line;
    }

    /* mode visuals only */
    body.mode-study canvas{
      background-image:
        linear-gradient(rgba(37,99,235,0.10) 1px, transparent 1px),
        linear-gradient(90deg, rgba(37,99,235,0.10) 1px, transparent 1px);
      background-size:24px 24px;
      background-color:#ffffff;
    }
    body.mode-meeting canvas{
      background: linear-gradient(180deg, #ffffff 0%, #fbfcff 100%);
    }
    body.mode-free canvas{
      background:
        radial-gradient(700px 340px at 20% 20%, rgba(251,191,36,0.18) 0%, rgba(251,191,36,0) 70%),
        radial-gradient(700px 340px at 80% 30%, rgba(236,72,153,0.14) 0%, rgba(236,72,153,0) 70%),
        #ffffff;
    }

    /* hide debug UI without removing logic */
    #connStatus, #wsTxt, #rtcTxt, #voiceState, #dbg { display:none; }

    /* language switch */
    .langSwitch{
      display:inline-flex;
      align-items:center;
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      background:#fbfcff;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
      flex:0 0 auto;
    }
    .langBtn{
      appearance:none;
      border:0;
      background:transparent;
      color:rgba(11,18,32,0.65);
      padding:10px 10px;
      width:44px;
      min-width:44px;
      text-align:center;
      font-weight:950;
      font-size:12px;
      line-height:1;
      cursor:pointer;
      user-select:none;
      box-shadow:none;
      border-radius:0;
    }
    .langBtn.isActive{
      background:rgba(37,99,235,0.10);
      color:rgba(11,18,32,0.95);
    }

    /* mobile floating controls */
    .fabBar{
      display:none;
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:14px;
      z-index:50;
      background:rgba(255,255,255,0.86);
      border:1px solid var(--line);
      border-radius:999px;
      box-shadow:0 18px 50px rgba(15,23,42,0.18);
      padding:10px;
      gap:10px;
      align-items:center;
      backdrop-filter: blur(10px);
    }
    .fabBtn{
      width:52px;
      height:52px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#f2f5fb;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      font-weight:950;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(15,23,42,0.10);
    }
    .fabBtn.on{
      background:var(--btn);
      border-color:rgba(37,99,235,0.25);
      color:#fff;
    }

    @media (max-width:1060px){
      .wrap{grid-template-columns:1fr}
      .stage{min-height:520px}
      input[type="range"]{width:120px}
      .fabBar{display:flex}
      .right .desktopTools{display:none}
      .wrap{padding-bottom:86px}
    }

    /* MOBILE TOPBAR COMPACT, KEEP ALL CONTROLS */
    @media (max-width: 768px) {
      .topbar {
        padding: 6px 8px;
        gap: 8px;
      }

      .left {
        flex-wrap: nowrap;
        gap: 6px;
        min-width: 0;
      }

      .brand {
        font-size: 14px;
        line-height: 1;
      }

      .roomLine {
        font-size: 11px;
        line-height: 1;
        max-width: 140px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .right .desktopTools {
        display: flex !important;
        flex-wrap: nowrap;
        align-items: center;
        gap: 8px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        max-width: 62vw;
        padding-bottom: 2px;
      }

      .right .desktopTools::-webkit-scrollbar {
        height: 0;
      }

      button {
        padding: 8px 10px;
        border-radius: 14px;
        font-size: 12px;
        box-shadow: none;
      }

      input {
        padding: 8px 10px;
        border-radius: 14px;
        font-size: 12px;
        box-shadow: none;
      }

      input#roomInput {
        width: 120px;
      }

      input[type="range"] {
        width: 90px;
      }

      input[type="color"] {
        width: 36px;
        height: 36px;
        border-radius: 14px;
      }

      .langBtn{
        padding:8px 8px;
        width:40px;
        min-width:40px;
        font-size:12px;
      }

      .wrap {
        padding: 10px 10px 72px 10px;
      }

      .stage {
        min-height: 380px;
      }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="left">
      <div class="brand">unline</div>
      <div class="roomLine" id="roomLine">Room</div>
    </div>

    <div class="right">
      <div class="desktopTools" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <div class="langSwitch" role="group" aria-label="Language">
          <button type="button" class="langBtn" data-lang="en" aria-pressed="false">EN</button>
          <button type="button" class="langBtn" data-lang="ko" aria-pressed="false">KR</button>
          <button type="button" class="langBtn" data-lang="ja" aria-pressed="false">JP</button>
        </div>

        <button id="homeBtn">Home</button>

        <button id="penBtn" class="primary">Pen</button>
        <button id="eraserBtn">Eraser</button>

        <input id="colorInput" type="color" value="#111827" />
        <div style="display:flex;align-items:center;gap:10px">
          <input id="widthInput" type="range" min="1" max="18" value="3" />
          <span id="widthTxt" style="font-weight:950;color:var(--muted)">3</span>
        </div>

        <input id="roomInput" placeholder="Room" />
        <button id="goRoomBtn">Go</button>
        <button id="clearBtn" class="danger">Clear</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="col">
      <div class="card">
        <h3 id="peopleTitle">People</h3>
        <div id="manageBox" style="display:none">
          <div id="userList"></div>
        </div>
        <div class="meta" id="hintTxt"></div>
      </div>

      <div class="card">
        <h3 id="voiceTitle">Voice</h3>
        <div class="row">
          <button id="startVoiceBtn" class="primary">Start voice</button>
          <button id="stopVoiceBtn" class="danger" disabled>Stop</button>
        </div>
        <audio id="remoteAudio" autoplay playsinline></audio>
        <div id="voiceState">Idle</div>
        <div id="dbg"></div>
      </div>
    </div>

    <div class="stage">
      <canvas id="board"></canvas>
    </div>
  </div>

  <!-- mobile floating controls -->
  <div class="fabBar" id="fabBar" aria-label="mobile controls">
    <div class="fabBtn" id="fabMic" title="Voice">üé§</div>
    <div class="fabBtn on" id="fabPen" title="Pen">‚úèÔ∏è</div>
    <div class="fabBtn" id="fabEraser" title="Eraser">üßΩ</div>
  </div>

  <div id="connStatus">Offline</div>
  <div id="wsTxt">offline</div>
  <div id="rtcTxt">idle</div>

  <script>
    const $ = (id) => document.getElementById(id);

    /* =========================
       i18n
       ========================= */
    const LANG_KEY = "unline_lang";
    const SUPPORTED = new Set(["en","ko","ja"]);
    let currentLang = "en";

    const I18N = {
      en: {
        home: "Home",
        pen: "Pen",
        eraser: "Eraser",
        roomPlaceholder: "Room",
        go: "Go",
        clear: "Clear",
        peopleTitle: "People",
        voiceTitle: "Voice",
        startVoice: "Start voice",
        stop: "Stop",
        you: "You",
        member: "Member",
        roomPrefix: "Room",
        peopleSuffix: "people",
        hint1: "Join the same room to connect instantly.",
        hint2: "Voice and drawing work in participant mode.",
        confirmJoinVoice: "Join the voice chat?",
        notAllowed: "Not allowed",
        requesting: "Requesting",
        accepted: "Accepted",
        connecting: "Connecting",
        connected: "Connected",
        rejected: "Rejected",
        stopped: "Stopped",
        peerStopped: "Peer stopped",
        voiceError: "Voice error",
        fabMicTitle: "Voice",
        fabPenTitle: "Pen",
        fabEraserTitle: "Eraser",
        mobileControlsAria: "mobile controls"
      },
      ko: {
        home: "Ìôà",
        pen: "Ìéú",
        eraser: "ÏßÄÏö∞Í∞ú",
        roomPlaceholder: "Î∞© ÏΩîÎìú",
        go: "Ïù¥Îèô",
        clear: "ÏßÄÏö∞Í∏∞",
        peopleTitle: "ÏÇ¨Îûå",
        voiceTitle: "ÏùåÏÑ±",
        startVoice: "ÏùåÏÑ± ÏãúÏûë",
        stop: "Ï§ëÏßÄ",
        you: "ÎÇò",
        member: "Î©§Î≤Ñ",
        roomPrefix: "Î∞©",
        peopleSuffix: "Î™Ö",
        hint1: "Í∞ôÏùÄ Î∞© Ïù¥Î¶ÑÏúºÎ°ú Ï†ëÏÜçÌïòÎ©¥ Î∞îÎ°ú Ïó∞Í≤∞Îê©ÎãàÎã§.",
        hint2: "ÏùåÏÑ±Í≥º Í∑∏Î¶ºÏùÄ participantÏóêÏÑú ÏÇ¨Ïö©Îê©ÎãàÎã§.",
        confirmJoinVoice: "Î≥¥Ïù¥Ïä§ ÎåÄÌôîÏóê Ï∞∏Ïó¨Ìï†ÍπåÏöî?",
        notAllowed: "Í∂åÌïú ÏóÜÏùå",
        requesting: "ÏöîÏ≤≠ Ï§ë",
        accepted: "ÏàòÎùΩÎê®",
        connecting: "Ïó∞Í≤∞ Ï§ë",
        connected: "Ïó∞Í≤∞Îê®",
        rejected: "Í±∞Ï†àÎê®",
        stopped: "Ï§ëÏßÄÎê®",
        peerStopped: "ÏÉÅÎåÄÍ∞Ä Ï¢ÖÎ£åÌï®",
        voiceError: "ÏùåÏÑ± Ïò§Î•ò",
        fabMicTitle: "ÏùåÏÑ±",
        fabPenTitle: "Ìéú",
        fabEraserTitle: "ÏßÄÏö∞Í∞ú",
        mobileControlsAria: "Î™®Î∞îÏùº Ïª®Ìä∏Î°§"
      },
      ja: {
        home: "„Éõ„Éº„É†",
        pen: "„Éö„É≥",
        eraser: "Ê∂à„Åó„Ç¥„É†",
        roomPlaceholder: "„É´„Éº„É†„Ç≥„Éº„Éâ",
        go: "ÁßªÂãï",
        clear: "„ÇØ„É™„Ç¢",
        peopleTitle: "ÂèÇÂä†ËÄÖ",
        voiceTitle: "Èü≥Â£∞",
        startVoice: "Èü≥Â£∞ÈñãÂßã",
        stop: "ÂÅúÊ≠¢",
        you: "Ëá™ÂàÜ",
        member: "„É°„É≥„Éê„Éº",
        roomPrefix: "„É´„Éº„É†",
        peopleSuffix: "‰∫∫",
        hint1: "Âêå„Åò„É´„Éº„É†Âêç„ÅßÂÖ•„Çã„Å®„Åô„ÅêÊé•Á∂ö„Åï„Çå„Åæ„Åô„ÄÇ",
        hint2: "Èü≥Â£∞„Å®ÊèèÁîª„ÅØ participant „ÅßÂà©Áî®„Åß„Åç„Åæ„Åô„ÄÇ",
        confirmJoinVoice: "Èü≥Â£∞„ÉÅ„É£„ÉÉ„Éà„Å´ÂèÇÂä†„Åó„Åæ„Åô„ÅãÔºü",
        notAllowed: "Ë®±ÂèØ„Å™„Åó",
        requesting: "„É™„ÇØ„Ç®„Çπ„Éà‰∏≠",
        accepted: "ÊâøË™ç",
        connecting: "Êé•Á∂ö‰∏≠",
        connected: "Êé•Á∂öÂÆå‰∫Ü",
        rejected: "ÊãíÂê¶",
        stopped: "ÂÅúÊ≠¢",
        peerStopped: "Áõ∏Êâã„ÅåÁµÇ‰∫Ü",
        voiceError: "Èü≥Â£∞„Ç®„É©„Éº",
        fabMicTitle: "Èü≥Â£∞",
        fabPenTitle: "„Éö„É≥",
        fabEraserTitle: "Ê∂à„Åó„Ç¥„É†",
        mobileControlsAria: "„É¢„Éê„Ç§„É´Êìç‰Ωú"
      }
    };

    function getStoredLang() {
      const v = localStorage.getItem(LANG_KEY);
      if (v && SUPPORTED.has(v)) return v;
      return "en";
    }

    function setStoredLang(lang) {
      localStorage.setItem(LANG_KEY, lang);
    }

    function t(key) {
      const dict = I18N[currentLang] || I18N.en;
      return dict[key] ?? (I18N.en[key] ?? "");
    }

    function applyLang(lang) {
      currentLang = SUPPORTED.has(lang) ? lang : "en";
      setStoredLang(currentLang);
      document.documentElement.lang = currentLang;

      if ($("homeBtn")) $("homeBtn").textContent = t("home");
      if ($("penBtn")) $("penBtn").textContent = t("pen");
      if ($("eraserBtn")) $("eraserBtn").textContent = t("eraser");
      if ($("roomInput")) $("roomInput").placeholder = t("roomPlaceholder");
      if ($("goRoomBtn")) $("goRoomBtn").textContent = t("go");
      if ($("clearBtn")) $("clearBtn").textContent = t("clear");
      if ($("peopleTitle")) $("peopleTitle").textContent = t("peopleTitle");
      if ($("voiceTitle")) $("voiceTitle").textContent = t("voiceTitle");
      if ($("startVoiceBtn")) $("startVoiceBtn").textContent = t("startVoice");
      if ($("stopVoiceBtn")) $("stopVoiceBtn").textContent = t("stop");

      const fabBar = $("fabBar");
      if (fabBar) fabBar.setAttribute("aria-label", t("mobileControlsAria"));

      const fabMic = $("fabMic");
      const fabPen = $("fabPen");
      const fabEraser = $("fabEraser");
      if (fabMic) fabMic.title = t("fabMicTitle");
      if (fabPen) fabPen.title = t("fabPenTitle");
      if (fabEraser) fabEraser.title = t("fabEraserTitle");

      document.querySelectorAll(".langBtn").forEach(btn => {
        const isActive = btn.dataset.lang === currentLang;
        btn.classList.toggle("isActive", isActive);
        btn.setAttribute("aria-pressed", isActive ? "true" : "false");
      });

      updateUi();
    }

    function initI18nUi() {
      const initial = getStoredLang();
      applyLang(initial);

      document.querySelectorAll(".langBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const lang = btn.dataset.lang;
          if (!SUPPORTED.has(lang)) return;
          applyLang(lang);
        });
      });
    }

    /* =========================
       existing app logic
       ========================= */
    const qs = new URLSearchParams(location.search);
    let room = (qs.get("room") || "WELCOME").trim();

    const mode = (qs.get("mode") || localStorage.getItem("unline_mode") || "").trim();
    if (mode === "study") document.body.classList.add("mode-study");
    if (mode === "meeting") document.body.classList.add("mode-meeting");
    if (mode === "free") document.body.classList.add("mode-free");

    let clientId = (qs.get("clientId") || "").trim();
    if (!clientId) {
      const key = "unline_clientId";
      clientId = localStorage.getItem(key) || ("c" + Math.random().toString(16).slice(2, 10));
      localStorage.setItem(key, clientId);
    }

    const label = (qs.get("label") || "").trim();

    $("roomInput").value = room;

    const toolKey = "unline_tool";
    const colorKey = "unline_penColor";
    const widthKey = "unline_penWidth";

    let toolMode = localStorage.getItem(toolKey) || "pen";
    let penColor = localStorage.getItem(colorKey) || "#111827";
    let penWidth = Number(localStorage.getItem(widthKey) || 3);

    function dbg(t){ $("dbg").textContent = t || ""; }
    function setConn(online){ $("connStatus").textContent = online ? "Online" : "Offline"; }
    function setWsState(t){ $("wsTxt").textContent = t || "offline"; }
    function setRtcState(t){ $("rtcTxt").textContent = t || "idle"; }

    function syncToolUi(){
      $("penBtn").classList.toggle("primary", toolMode === "pen");
      $("eraserBtn").classList.toggle("primary", toolMode === "eraser");
      $("colorInput").disabled = toolMode !== "pen";
      $("widthInput").value = String(penWidth);
      $("widthTxt").textContent = String(penWidth);
      $("colorInput").value = penColor;

      $("fabPen").classList.toggle("on", toolMode === "pen");
      $("fabEraser").classList.toggle("on", toolMode === "eraser");
    }

    $("homeBtn").addEventListener("click", () => { location.href = "/"; });

    $("penBtn").addEventListener("click", () => {
      toolMode = "pen";
      localStorage.setItem(toolKey, toolMode);
      syncToolUi();
    });

    $("eraserBtn").addEventListener("click", () => {
      toolMode = "eraser";
      localStorage.setItem(toolKey, toolMode);
      syncToolUi();
    });

    $("colorInput").addEventListener("input", (e) => {
      penColor = e.target.value || "#111827";
      localStorage.setItem(colorKey, penColor);
      syncToolUi();
    });

    $("widthInput").addEventListener("input", (e) => {
      const v = Math.max(1, Math.min(18, Number(e.target.value || 3)));
      penWidth = v;
      localStorage.setItem(widthKey, String(penWidth));
      syncToolUi();
    });

    function buildWsUrl(){
      const proto = location.protocol === "https:" ? "wss" : "ws";
      const labelParam = label ? `&label=${encodeURIComponent(label)}` : "";
      return `${proto}://${location.host}/ws?room=${encodeURIComponent(room)}&clientId=${encodeURIComponent(clientId)}${labelParam}`;
    }

    let ws = null;
    function send(type, data = {}) {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type, ...data }));
    }

    let meRole = "viewer";
    let visitors = 0;
    let users = [];

    function canDraw(){ return meRole === "participant"; }
    function canVoice(){ return meRole === "participant"; }

    function renderUserList() {
      const box = $("userList");
      box.textContent = "";
      for (const u of users) {
        const row = document.createElement("div");
        row.className = "userRow";

        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.alignItems = "center";
        left.style.gap = "10px";

        const badge = document.createElement("div");
        badge.className = "badge";
        badge.style.background = u.color || "#94a3b8";

        const txt = document.createElement("div");
        txt.style.fontSize = "13px";
        txt.style.fontWeight = "950";
        txt.style.color = "var(--text)";
        txt.textContent = u.clientId === clientId ? t("you") : (u.label || t("member"));

        left.appendChild(badge);
        left.appendChild(txt);

        const right = document.createElement("div");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = u.role === "participant";
        cb.disabled = u.clientId === clientId;
        cb.addEventListener("change", () => {
          send("set_role", { targetClientId: u.clientId, role: cb.checked ? "participant" : "viewer" });
        });
        right.appendChild(cb);

        row.appendChild(left);
        row.appendChild(right);
        box.appendChild(row);
      }
    }

    function updateRoomLine() {
      const peopleText = `${visitors} ${t("peopleSuffix")}`;
      $("roomLine").textContent = `${t("roomPrefix")} ${room} ¬∑ ${peopleText}`;
    }

    function updateUi() {
      $("clearBtn").disabled = !canDraw();
      $("startVoiceBtn").disabled = !canVoice() || callActive;
      $("stopVoiceBtn").disabled = !callActive;

      $("manageBox").style.display = meRole === "participant" ? "block" : "none";
      if (meRole === "participant") renderUserList();

      updateRoomLine();

      const hint = [];
      hint.push(t("hint1"));
      hint.push(t("hint2"));
      $("hintTxt").textContent = hint.join("\n");
    }

    function connect() {
      ws = new WebSocket(buildWsUrl());

      ws.addEventListener("open", () => {
        setConn(true);
        setWsState("online");
        updateUi();
      });

      ws.addEventListener("close", () => {
        setConn(false);
        setWsState("offline");
        updateUi();
      });

      ws.addEventListener("message", (evt) => {
        let
