<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>unline</title>
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --line:#e6eaf2;
      --text:#0b1220;
      --muted:#5a677f;
      --btn:#2563eb;
      --btn2:#0f172a;
      --danger:#ef4444;
      --shadow: 0 14px 44px rgba(15,23,42,0.10);
      --radius:20px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 18% 10%, #eaf2ff 0%, rgba(234,242,255,0) 60%),
        radial-gradient(900px 520px at 82% 0%, #f1ecff 0%, rgba(241,236,255,0) 55%),
        var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto;
      display:flex;
      flex-direction:column;
      min-height:100%;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,0.72);
      backdrop-filter: blur(10px);
      position:sticky;
      top:0;
      z-index:20;
    }
    .left,.right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .left{min-width:0}

    /* logo same as index */
    .brand{
      display:inline-flex;
      align-items:center;
      gap:10px;
      font-weight:950;
      letter-spacing:-0.02em;
      padding:8px 12px;
      border-radius:16px;
      background:
        radial-gradient(180px 80px at 20% 20%, rgba(37,99,235,0.20) 0%, rgba(37,99,235,0) 70%),
        radial-gradient(220px 90px at 80% 40%, rgba(168,85,247,0.16) 0%, rgba(168,85,247,0) 70%),
        rgba(255,255,255,0.72);
      border:1px solid rgba(230,234,242,0.9);
      box-shadow:0 14px 36px rgba(15,23,42,0.10);
      white-space:nowrap;
      cursor:pointer;
      user-select:none;
      flex:0 0 auto;
    }
    .logoMark{
      width:18px;
      height:18px;
      border-radius:8px;
      background:linear-gradient(135deg, #2563eb 0%, #7c3aed 55%, #0ea5e9 100%);
      box-shadow:0 10px 24px rgba(37,99,235,0.22);
      flex:0 0 auto;
    }
    .logoText{
      background:linear-gradient(90deg, #2563eb 0%, #7c3aed 55%, #0ea5e9 100%);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      font-size:16px;
      font-weight:950;
      letter-spacing:-0.02em;
    }

    .roomLine{
      color:var(--muted);
      font-weight:900;
      font-size:13px;
      letter-spacing:-0.01em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:46vw;
    }

    button{
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      cursor:pointer;
      color:var(--text);
      background:#f2f5fb;
      font-weight:950;
      font-size:13px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
      -webkit-tap-highlight-color: transparent;
    }
    button.primary{
      background:var(--btn);
      border-color:rgba(37,99,235,0.25);
      color:#fff;
    }
    button.danger{
      background:rgba(239,68,68,0.08);
      border-color:rgba(239,68,68,0.25);
      color:#b91c1c;
    }
    button:disabled{opacity:0.55;cursor:not-allowed}

    input{
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fbfcff;
      color:var(--text);
      font-weight:900;
      font-size:13px;
      outline:none;
      width:170px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
    }
    input[type="color"]{
      width:44px;
      height:40px;
      padding:0;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fbfcff;
    }
    input[type="range"]{
      width:140px;
      accent-color: var(--btn);
    }

    .wrap{
      flex:1;
      display:grid;
      grid-template-columns:280px 1fr;
      gap:14px;
      padding:14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .col{display:flex;flex-direction:column;gap:14px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow);
    }
    .card h3{
      margin:0 0 12px;
      font-size:12px;
      color:var(--muted);
      font-weight:950;
      letter-spacing:0.08em;
      text-transform:uppercase;
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .stage{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
      min-height:560px;
    }
    canvas{
      width:100%;
      height:100%;
      display:block;
      touch-action:none;
      background:#ffffff;
    }

    .userRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:#fbfcff;
      margin-top:10px;
    }
    .badge{
      width:12px;height:12px;border-radius:6px;border:1px solid var(--line);
    }
    .meta{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      line-height:1.55;
      margin-top:10px;
      white-space:pre-line;
    }

    /* mode visuals only */
    body.mode-study canvas{
      background-image:
        linear-gradient(rgba(37,99,235,0.10) 1px, transparent 1px),
        linear-gradient(90deg, rgba(37,99,235,0.10) 1px, transparent 1px);
      background-size:24px 24px;
      background-color:#ffffff;
    }
    body.mode-meeting canvas{
      background: linear-gradient(180deg, #ffffff 0%, #fbfcff 100%);
    }
    body.mode-free canvas{
      background:
        radial-gradient(700px 340px at 20% 20%, rgba(251,191,36,0.18) 0%, rgba(251,191,36,0) 70%),
        radial-gradient(700px 340px at 80% 30%, rgba(236,72,153,0.14) 0%, rgba(236,72,153,0) 70%),
        #ffffff;
    }

    /* hide debug UI without removing logic */
    #connStatus, #wsTxt, #rtcTxt, #voiceState, #dbg { display:none; }

    /* language switch (kept OUTSIDE desktopTools so it remains clickable) */
    .langSwitch{
      flex:0 0 auto;
      display:inline-flex;
      align-items:center;
      border:1px solid rgba(11,18,32,0.12);
      border-radius:14px;
      overflow:hidden;
      background:#fbfcff;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
    }
    .langBtn{
      appearance:none;
      border:0;
      background:transparent;
      color:rgba(11,18,32,0.62);
      padding:8px 10px;
      width:44px;
      min-width:44px;
      text-align:center;
      font-weight:950;
      font-size:12px;
      line-height:1;
      cursor:pointer;
      user-select:none;
    }
    .langBtn.isActive{
      background:rgba(37,99,235,0.10);
      color:rgba(11,18,32,0.95);
    }

    /* mobile floating controls */
    .fabBar{
      display:none;
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:14px;
      z-index:50;
      background:rgba(255,255,255,0.86);
      border:1px solid var(--line);
      border-radius:999px;
      box-shadow:0 18px 50px rgba(15,23,42,0.18);
      padding:10px;
      gap:10px;
      align-items:center;
      backdrop-filter: blur(10px);
    }
    .fabBtn{
      width:52px;
      height:52px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#f2f5fb;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      font-weight:950;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(15,23,42,0.10);
    }
    .fabBtn.on{
      background:var(--btn);
      border-color:rgba(37,99,235,0.25);
      color:#fff;
    }

    @media (max-width:1060px){
      .wrap{grid-template-columns:1fr}
      .stage{min-height:520px}
      input[type="range"]{width:120px}
      .fabBar{display:flex}
      .right .desktopTools{display:none}
      .wrap{padding-bottom:86px}
    }

    /* =========================
       MOBILE TOPBAR COMPACT, KEEP ALL CONTROLS
       ========================= */
    @media (max-width: 768px) {
      .topbar {
        padding: 6px 8px;
        gap: 8px;
      }

      .left {
        flex-wrap: nowrap;
        gap: 6px;
        min-width: 0;
      }

      .roomLine {
        font-size: 11px;
        line-height: 1;
        max-width: 34vw;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* mobileÏóêÏÑúÎèÑ ÏÉÅÎã® ÎèÑÍµ¨Îäî Ïà®Í∏∞ÏßÄ ÏïäÎäîÎã§ */
      .right .desktopTools {
        display: flex !important;
        flex-wrap: nowrap;
        align-items: center;
        gap: 8px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        max-width: 50vw;
        padding-bottom: 2px;
      }

      .right .desktopTools::-webkit-scrollbar {
        height: 0;
      }

      button {
        padding: 8px 10px;
        border-radius: 14px;
        font-size: 12px;
        box-shadow: none;
      }

      input {
        padding: 8px 10px;
        border-radius: 14px;
        font-size: 12px;
        box-shadow: none;
      }

      input#roomInput {
        width: 120px;
      }

      input[type="range"] {
        width: 90px;
      }

      input[type="color"] {
        width: 36px;
        height: 36px;
        border-radius: 14px;
      }

      .wrap {
        padding: 10px 10px 72px 10px;
      }

      .stage {
        min-height: 380px;
      }

      .langBtn{
        width:40px;
        min-width:40px;
        padding:7px 8px;
      }
    }
    @media (max-width: 768px) {
  /* ÏÉÅÎã®ÏùÑ 2Ï§Ñ Íµ¨Ï°∞Î°ú Ï†ïÎ¶¨ */
  .topbar {
    flex-wrap: wrap;
    align-items: stretch;
    gap: 8px;
  }

  /* 1Ï§Ñ: Î°úÍ≥† + Î∞© Ï†ïÎ≥¥ */
  .left {
    width: 100%;
    justify-content: space-between;
    flex-wrap: nowrap;
    gap: 8px;
  }

  .roomLine {
    max-width: 52vw;
    text-align: right;
  }

  /* 2Ï§Ñ: ÎèÑÍµ¨ + Ïñ∏Ïñ¥ */
  .right {
    width: 100%;
    justify-content: space-between;
    align-items: center;
    flex-wrap: nowrap;
    gap: 10px;
  }

  /* ÎèÑÍµ¨Îäî Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§Î°ú ÌùòÎ¶¨Í∏∞ */
  .right .desktopTools {
    display: flex !important;
    flex: 1 1 auto;
    min-width: 0;
    flex-wrap: nowrap !important;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    gap: 8px;
    padding-bottom: 2px;
  }

  .right .desktopTools::-webkit-scrollbar {
    height: 0;
  }

  /* Ïñ∏Ïñ¥ Î∞ïÏä§Îäî Ïò§Î•∏Ï™ΩÏóê Í≥†Ï†ï */
  .langSwitch {
    flex: 0 0 auto;
    display: inline-flex !important;
  }

  /* Î≤ÑÌäºÍ≥º Ïù∏Ìíã ÎÜíÏù¥ ÌÜµÏùº */
  button {
    padding: 8px 10px;
    border-radius: 14px;
    font-size: 12px;
    box-shadow: none;
    white-space: nowrap;
  }

  input {
    padding: 8px 10px;
    border-radius: 14px;
    font-size: 12px;
    box-shadow: none;
  }

  input#roomInput {
    width: 120px;
  }

  input[type="range"] {
    width: 90px;
  }

  input[type="color"] {
    width: 36px;
    height: 36px;
    border-radius: 14px;
  }
}
    /* hide Home button but keep logic intact */
#homeBtn { display:none !important; }
    @media (max-width: 768px) {
  /* top toolsÎäî Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§Ïù¥ ÏÉùÍ∏∞ÎØÄÎ°ú, ÏÉâÏÉÅ ÏÑ†ÌÉùÏùÄ Ïò§Î•∏Ï™Ω Í≥†Ï†ïÏúºÎ°ú ÎπºÏ§ÄÎã§ */
  #colorInput {
    display: inline-block !important;
    visibility: visible !important;
    opacity: 1 !important;
    flex: 0 0 auto !important;
  }

  /* desktopTools ÎÇ¥Î∂ÄÏóêÏÑú colorInputÏù¥ Î∞ÄÎ†§ ÏÇ¨ÎùºÏßÄÎäî Í≤ΩÏö∞ Î∞©ÏßÄ */
  .right {
    gap: 8px;
  }

  /* ÎèÑÍµ¨Ï§ÑÏù¥ Ïä§ÌÅ¨Î°§ÎêòÎçîÎùºÎèÑ ÏÉâÏÉÅÏùÄ Ïïà Î∞ÄÎ¶¨Í≤å */
  .right .desktopTools {
    flex: 1 1 auto;
    min-width: 0;
  }

  /* Ïñ∏Ïñ¥ Î∞ïÏä§ ÏòÜÏóê ÏÉâÏÉÅ ÏÑ†ÌÉùÏù¥ Îì§Ïñ¥Í∞à Í≥µÍ∞Ñ ÌôïÎ≥¥ */
  .langSwitch {
    margin-left: 6px;
  }
}
@media (max-width: 768px) {
  /* Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§ ÏïàÏóêÏÑú ÏÉâÏÉÅ ÏÑ†ÌÉùÏù¥ ÌôîÎ©¥Ïóê Î∂ôÏñ¥ÏûàÍ≤å */
  #colorInput {
    position: sticky;
    right: 0;
    z-index: 2;
  }
}
    /* People Î¶¨Ïä§Ìä∏ÏóêÏÑú Ïù¥Î¶ÑÏù¥ Í∏ÄÏûê Îã®ÏúÑÎ°ú Ï§ÑÎ∞îÍøàÎêòÎäî ÌòÑÏÉÅ Î∞©ÏßÄ */
.userName{
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  min-width: 0;
}

/* Ï¢åÏ∏° ÏòÅÏó≠Ïù¥ Ï§ÑÏñ¥Îì§ Îïå ÎßêÏ§ÑÏûÑÌëúÍ∞Ä ÎèôÏûëÌïòÎèÑÎ°ù */
.userRow > div:first-child{
  min-width: 0;
  flex: 1 1 auto;
}

  </style>
</head>
<body>
  <div class="topbar">
    <div class="left">
      <div class="brand" id="brandHome" role="button" tabindex="0" aria-label="Home">
        <span class="logoMark" aria-hidden="true"></span>
        <span class="logoText">unline</span>
      </div>
      <div class="roomLine" id="roomLine">Room</div>
    </div>

    <div class="right">
      <div class="desktopTools" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <button id="homeBtn">Home</button>

        <button id="penBtn" class="primary">Pen</button>
        <button id="eraserBtn">Eraser</button>

        <input id="colorInput" type="color" value="#111827" />
        <div style="display:flex;align-items:center;gap:10px">
          <input id="widthInput" type="range" min="1" max="18" value="3" />
          <span id="widthTxt" style="font-weight:950;color:var(--muted)">3</span>
        </div>

        <input id="roomInput" placeholder="Room" />
        <button id="goRoomBtn">Go</button>
        <button id="clearBtn" class="danger">Clear</button>
      </div>

      <div class="langSwitch" role="group" aria-label="Language">
        <button type="button" class="langBtn" data-lang="en" aria-pressed="false">EN</button>
        <button type="button" class="langBtn" data-lang="ko" aria-pressed="false">KR</button>
        <button type="button" class="langBtn" data-lang="ja" aria-pressed="false">JP</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="col">
      <div class="card">
        <h3 id="peopleTitle">People</h3>
        <div id="manageBox">
          <div id="userList"></div>
        </div>
        <div class="meta" id="hintTxt"></div>
      </div>

      <div class="card">
        <h3 id="voiceTitle">Voice</h3>
        <div class="row">
          <button id="startVoiceBtn" class="primary">Start voice</button>
          <button id="stopVoiceBtn" class="danger" disabled>Stop</button>
        </div>
        <audio id="remoteAudio" autoplay playsinline></audio>
        <div id="voiceState">Idle</div>
        <div id="dbg"></div>
      </div>
    </div>

    <div class="stage">
      <canvas id="board"></canvas>
    </div>
  </div>

  <!-- mobile floating controls -->
  <div class="fabBar" aria-label="mobile controls">
    <div class="fabBtn" id="fabMic" title="Voice">üé§</div>
    <div class="fabBtn on" id="fabPen" title="Pen">‚úèÔ∏è</div>
    <div class="fabBtn" id="fabEraser" title="Eraser">üßΩ</div>
  </div>

  <div id="connStatus">Offline</div>
  <div id="wsTxt">offline</div>
  <div id="rtcTxt">idle</div>

  <script>
    const $ = (id) => document.getElementById(id);

    /* =========================
       i18n layer (UI text only)
       ========================= */
    const LANG_KEY = "unline_lang";
    const SUPPORTED_LANGS = new Set(["en","ko","ja"]);
    let uiLang = "en";

    const I18N = {
      en: {
        peopleTitle: "People",
        voiceTitle: "Voice",
        home: "Home",
        pen: "Pen",
        eraser: "Eraser",
        roomPlaceholder: "Room",
        go: "Go",
        clear: "Clear",
        startVoice: "Start voice",
        stop: "Stop",
        you: "You",
        member: "Member",
        roleViewer: "Viewer",
        roleParticipant: "Participant",
        hint1: "Join the same room to connect instantly.",
        hint2: "Voice and drawing work in participant mode.",
        confirmVoice: "Join voice chat?",
        roomLabel: "Room",
        peopleWord: "people"
      },
      ko: {
        peopleTitle: "People",
        voiceTitle: "Voice",
        home: "Home",
        pen: "Pen",
        eraser: "Eraser",
        roomPlaceholder: "Î∞©",
        go: "Ïù¥Îèô",
        clear: "ÏßÄÏö∞Í∏∞",
        startVoice: "Î≥¥Ïù¥Ïä§ ÏãúÏûë",
        stop: "Ï§ëÏßÄ",
        you: "ÎÇò",
        member: "Î©§Î≤Ñ",
        roleViewer: "Î∑∞Ïñ¥",
        roleParticipant: "Ï∞∏Í∞ÄÏûê",
        hint1: "Í∞ôÏùÄ Î∞© Ïù¥Î¶ÑÏúºÎ°ú Ï†ëÏÜçÌïòÎ©¥ Î∞îÎ°ú Ïó∞Í≤∞Îê©ÎãàÎã§.",
        hint2: "Î≥¥Ïù¥Ïä§ÏôÄ Í∑∏Î¶ºÏùÄ Ï∞∏Í∞ÄÏûê Î™®ÎìúÏóêÏÑú ÏÇ¨Ïö©Îê©ÎãàÎã§.",
        confirmVoice: "Î≥¥Ïù¥Ïä§ ÎåÄÌôîÏóê Ï∞∏Ïó¨Ìï†ÍπåÏöî?",
        roomLabel: "Î∞©",
        peopleWord: "Î™Ö"
      },
      ja: {
        peopleTitle: "People",
        voiceTitle: "Voice",
        home: "Home",
        pen: "Pen",
        eraser: "Eraser",
        roomPlaceholder: "„É´„Éº„É†",
        go: "ÁßªÂãï",
        clear: "„ÇØ„É™„Ç¢",
        startVoice: "Èü≥Â£∞„ÇíÈñãÂßã",
        stop: "ÂÅúÊ≠¢",
        you: "Ëá™ÂàÜ",
        member: "„É°„É≥„Éê„Éº",
        roleViewer: "Èñ≤Ë¶ß",
        roleParticipant: "ÂèÇÂä†",
        hint1: "Âêå„Åò„É´„Éº„É†Âêç„ÅßÂÖ•„Çã„Å®„Åô„ÅêÊé•Á∂ö„Åï„Çå„Åæ„Åô„ÄÇ",
        hint2: "Èü≥Â£∞„Å®ÊèèÁîª„ÅØÂèÇÂä†„É¢„Éº„Éâ„Åß‰Ωø„Åà„Åæ„Åô„ÄÇ",
        confirmVoice: "Èü≥Â£∞„ÉÅ„É£„ÉÉ„Éà„Å´ÂèÇÂä†„Åó„Åæ„Åô„ÅãÔºü",
        roomLabel: "„É´„Éº„É†",
        peopleWord: "‰∫∫"
      }
    };

    function t(key){
      const d = I18N[uiLang] || I18N.en;
      return d[key] || (I18N.en[key] || key);
    }

    function getStoredLang(){
      const v = localStorage.getItem(LANG_KEY);
      if (v && SUPPORTED_LANGS.has(v)) return v;
      return "en";
    }

    function setStoredLang(lang){
      localStorage.setItem(LANG_KEY, lang);
    }

    function applyLang(lang){
      uiLang = SUPPORTED_LANGS.has(lang) ? lang : "en";
      document.documentElement.lang = uiLang;

      $("peopleTitle").textContent = t("peopleTitle");
      $("voiceTitle").textContent = t("voiceTitle");

      $("homeBtn").textContent = t("home");
      $("penBtn").textContent = t("pen");
      $("eraserBtn").textContent = t("eraser");
      $("goRoomBtn").textContent = t("go");
      $("clearBtn").textContent = t("clear");

      $("roomInput").placeholder = t("roomPlaceholder");

      $("startVoiceBtn").textContent = t("startVoice");
      $("stopVoiceBtn").textContent = t("stop");

      document.querySelectorAll(".langBtn").forEach(btn => {
        const active = btn.dataset.lang === uiLang;
        btn.classList.toggle("isActive", active);
        btn.setAttribute("aria-pressed", active ? "true" : "false");
      });

      /* IMPORTANT: no updateUi() call here (prevents breaking voice/tool logic) */
    }

    function initLangSwitch(){
      const initial = getStoredLang();
      applyLang(initial);

      document.querySelectorAll(".langBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const lang = btn.dataset.lang;
          if (!SUPPORTED_LANGS.has(lang)) return;
          setStoredLang(lang);
          applyLang(lang);
          renderUserList();
          updateRoomLine();
          updateHintOnly();
        });
      });
    }

    function updateHintOnly(){
      const hint = [];
      hint.push(t("hint1"));
      hint.push(t("hint2"));
      $("hintTxt").textContent = hint.join("\n");
    }

    /* =========================
       ORIGINAL LOGIC (kept)
       ========================= */
    const qs = new URLSearchParams(location.search);
    let room = (qs.get("room") || "WELCOME").trim();

    const mode = (qs.get("mode") || localStorage.getItem("unline_mode") || "").trim();
    if (mode === "study") document.body.classList.add("mode-study");
    if (mode === "meeting") document.body.classList.add("mode-meeting");
    if (mode === "free") document.body.classList.add("mode-free");

    let clientId = (qs.get("clientId") || "").trim();
    if (!clientId) {
      const key = "unline_clientId";
      clientId = localStorage.getItem(key) || ("c" + Math.random().toString(16).slice(2, 10));
      localStorage.setItem(key, clientId);
    }

    const label = (qs.get("label") || "").trim();

    $("roomInput").value = room;

    const toolKey = "unline_tool";
    const colorKey = "unline_penColor";
    const widthKey = "unline_penWidth";

    let toolMode = localStorage.getItem(toolKey) || "pen";
    let penColor = localStorage.getItem(colorKey) || "#111827";
    let penWidth = Number(localStorage.getItem(widthKey) || 3);

    function dbg(t){ $("dbg").textContent = t || ""; }
    function setConn(online){ $("connStatus").textContent = online ? "Online" : "Offline"; }
    function setWsState(t){ $("wsTxt").textContent = t || "offline"; }
    function setRtcState(t){ $("rtcTxt").textContent = t || "idle"; }

    function syncToolUi(){
      $("penBtn").classList.toggle("primary", toolMode === "pen");
      $("eraserBtn").classList.toggle("primary", toolMode === "eraser");
      $("colorInput").disabled = toolMode !== "pen";
      $("widthInput").value = String(penWidth);
      $("widthTxt").textContent = String(penWidth);
      $("colorInput").value = penColor;

      $("fabPen").classList.toggle("on", toolMode === "pen");
      $("fabEraser").classList.toggle("on", toolMode === "eraser");
    }

    $("brandHome").addEventListener("click", () => { location.href = "/"; });
    $("brandHome").addEventListener("keydown", (e) => { if (e.key === "Enter") location.href = "/"; });

    $("homeBtn").addEventListener("click", () => { location.href = "/"; });

    $("penBtn").addEventListener("click", () => {
      toolMode = "pen";
      localStorage.setItem(toolKey, toolMode);
      syncToolUi();
    });

    $("eraserBtn").addEventListener("click", () => {
      toolMode = "eraser";
      localStorage.setItem(toolKey, toolMode);
      syncToolUi();
    });

    $("colorInput").addEventListener("input", (e) => {
      penColor = e.target.value || "#111827";
      localStorage.setItem(colorKey, penColor);
      syncToolUi();
    });

    $("widthInput").addEventListener("input", (e) => {
      const v = Math.max(1, Math.min(18, Number(e.target.value || 3)));
      penWidth = v;
      localStorage.setItem(widthKey, String(penWidth));
      syncToolUi();
    });

    function buildWsUrl(){
      const proto = location.protocol === "https:" ? "wss" : "ws";
      const labelParam = label ? `&label=${encodeURIComponent(label)}` : "";
      return `${proto}://${location.host}/ws?room=${encodeURIComponent(room)}&clientId=${encodeURIComponent(clientId)}${labelParam}`;
    }

    let ws = null;
    function send(type, data = {}) {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type, ...data }));
    }

    let meRole = "viewer";
    let visitors = 0;
    let users = [];

    function canDraw(){ return meRole === "participant"; }
    function canVoice(){ return meRole === "participant"; }

    function renderUserList() {
      const box = $("userList");
      box.textContent = "";
      for (const u of users) {
        const row = document.createElement("div");
        row.className = "userRow";

        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.alignItems = "center";
        left.style.gap = "10px";

        const badge = document.createElement("div");
        badge.className = "badge";
        badge.style.background = u.color || "#94a3b8";

        const txtWrap = document.createElement("div");
        txtWrap.style.display = "flex";
        txtWrap.style.flexDirection = "row"; 
        txtWrap.style.alignItems = "center";
        txtWrap.style.gap = "6px";
        txtWrap.style.minWidth = "0";
        txtWrap.style.flexWrap = "nowrap";

        const name = document.createElement("div");
        name.className = "userNameLine";
        name.style.fontSize = "13px";
        name.style.fontWeight = "950";
        name.style.color = "var(--text)";
        name.textContent = u.clientId === clientId ? t("you") : (u.label || t("member"));
        name.style.whiteSpace = "nowrap";
        name.style.flex = "0 0 auto";

        const roleLine = document.createElement("div");
        roleLine.className = "userRoleLine";
        roleLine.style.fontSize = "12px";
        roleLine.style.fontWeight = "850";
        roleLine.style.color = "var(--muted)";
        roleLine.textContent = "¬∑ " + (u.role === "participant" ? t("roleParticipant") : t("roleViewer"));
        roleLine.style.whiteSpace = "nowrap";
        roleLine.style.flex = "0 0 auto";

        txtWrap.appendChild(name);
        txtWrap.appendChild(roleLine);

        left.appendChild(badge);
        left.appendChild(txtWrap);

        const right = document.createElement("div");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = u.role === "participant";
        cb.disabled = (meRole !== "participant") || (u.clientId === clientId);
        cb.addEventListener("change", () => {
          send("set_role", { targetClientId: u.clientId, role: cb.checked ? "participant" : "viewer" });
        });
        right.appendChild(cb);

        row.appendChild(left);
        row.appendChild(right);
        box.appendChild(row);
      }
    }

    function updateRoomLine() {
      const peopleText = uiLang === "ko"
        ? `${visitors}${t("peopleWord")}`
        : `${visitors} ${t("peopleWord")}`;
      $("roomLine").textContent = `${t("roomLabel")} ${room} ¬∑ ${peopleText}`;
    }

    function updateUi() {
      $("clearBtn").disabled = !canDraw();
      $("startVoiceBtn").disabled = !canVoice() || callActive;
      $("stopVoiceBtn").disabled = !callActive;

      /* UI-only change: always show who is inside */
      $("manageBox").style.display = "block";
      renderUserList();

      updateRoomLine();
      updateHintOnly();
    }

    function connect() {
      ws = new WebSocket(buildWsUrl());

      ws.addEventListener("open", () => {
        setConn(true);
        setWsState("online");
        updateUi();
      });

      ws.addEventListener("close", () => {
        setConn(false);
        setWsState("offline");
        updateUi();
      });

      ws.addEventListener("message", (evt) => {
        let msg;
        try { msg = JSON.parse(evt.data); } catch { return; }

        if (msg.type === "room_state") {
          visitors = msg.visitors ?? visitors;
          users = msg.users ?? users;

          const me = users.find(x => x.clientId === clientId);
          if (me && me.role) meRole = me.role;

          updateUi();
          return;
        }

        if (msg.type === "canvas_snapshot") {
          applySnapshot(msg.strokes || []);
          return;
        }

        if (msg.type === "draw") { drawStroke(msg); return; }
        if (msg.type === "clear") { clearCanvas(false); return; }

        if (msg.type === "voice_request") return onVoiceRequest(msg);
        if (msg.type === "voice_accept") return onVoiceAccept(msg);
        if (msg.type === "voice_reject") return onVoiceReject(msg);
        if (msg.type === "voice_offer") return onVoiceOffer(msg);
        if (msg.type === "voice_answer") return onVoiceAnswer(msg);
        if (msg.type === "voice_ice") return onVoiceIce(msg);
        if (msg.type === "voice_stop") return onVoiceStop(msg);
      });
    }

    $("goRoomBtn").addEventListener("click", () => {
      const nextRoom = ($("roomInput").value || "").trim();
      if (!nextRoom) return;
      room = nextRoom;
      if (ws) { try { ws.close(); } catch {} }
      clearCanvas(false);
      connect();
      updateUi();
    });

    const canvas = $("board");
    const ctx = canvas.getContext("2d");

    function resize(){
      const rect = canvas.getBoundingClientRect();
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
    }
    window.addEventListener("resize", resize);
    resize();

    function clearCanvas(broadcast) {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if (broadcast) send("clear", {});
    }

    $("clearBtn").addEventListener("click", () => {
      if (!canDraw()) return;
      clearCanvas(true);
    });

    function drawStroke(s) {
      const a = s.a, b = s.b;
      const mode = s.mode || "pen";
      const w = Number(s.w || 3);
      const color = s.color || "#111827";

      const prev = ctx.globalCompositeOperation;
      if (mode === "eraser") {
        ctx.globalCompositeOperation = "destination-out";
        ctx.strokeStyle = "rgba(0,0,0,1)";
      } else {
        ctx.globalCompositeOperation = "source-over";
        ctx.strokeStyle = color;
      }

      ctx.lineWidth = w;
      ctx.beginPath();
      ctx.moveTo(a.x, a.y);
      ctx.lineTo(b.x, b.y);
      ctx.stroke();

      ctx.globalCompositeOperation = prev;
    }

    function applySnapshot(strokes) {
      clearCanvas(false);
      for (const s of strokes) drawStroke(s);
    }

    function posFromEvent(e){
      const rect = canvas.getBoundingClientRect();
      return { x: (e.clientX - rect.left), y: (e.clientY - rect.top) };
    }

    let drawing = false;
    let last = null;

    canvas.addEventListener("pointerdown", (e) => {
      if (!canDraw()) return;
      drawing = true;
      last = posFromEvent(e);
      canvas.setPointerCapture(e.pointerId);
    });

    canvas.addEventListener("pointermove", (e) => {
      if (!drawing) return;
      const p = posFromEvent(e);

      const stroke = { a: last, b: p, mode: toolMode, color: penColor, w: penWidth };
      drawStroke(stroke);
      send("draw", stroke);
      last = p;
    });

    canvas.addEventListener("pointerup", () => { drawing = false; last = null; });
    canvas.addEventListener("pointercancel", () => { drawing = false; last = null; });

    let iceServers = [{ urls: ["stun:stun.l.google.com:19302"] }];

    async function loadIceServers() {
      try {
        const r = await fetch("/api/ice", { cache: "no-store" });
        const j = await r.json();
        if (j && j.ok && Array.isArray(j.iceServers) && j.iceServers.length) {
          iceServers = j.iceServers;
        }
      } catch {}
    }

    let audioCtx = null;
    async function unlockAudioNoWait() {
      try {
        const a = $("remoteAudio");
        try { a.muted = false; } catch {}
        try { await a.play(); } catch {}

        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (Ctx && !audioCtx) audioCtx = new Ctx();
        if (audioCtx && audioCtx.state === "suspended") {
          try { await audioCtx.resume(); } catch {}
        }
      } catch {}
    }

    let pc = null;
    let localStream = null;
    let callActive = false;

    function setVoiceState(tState) {
      $("voiceState").textContent = tState || "Idle";
      setRtcState(tState || "idle");
      updateUi();
    }

    async function ensureLocalAudio() {
      if (localStream) return localStream;
      localStream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true },
        video: false
      });
      return localStream;
    }

    async function createPeer() {
      pc = new RTCPeerConnection({ iceServers });

      pc.onicecandidate = (e) => {
        if (e.candidate) send("voice_ice", { candidate: e.candidate });
      };

      pc.ontrack = async (e) => {
        const stream = e.streams && e.streams[0];
        if (!stream) return;
        const a = $("remoteAudio");
        a.srcObject = stream;
        try { await a.play(); } catch {}
      };

      const s = await ensureLocalAudio();
      s.getTracks().forEach(tk => pc.addTrack(tk, s));
    }

    function teardownVoice(state) {
      try { if (pc) pc.close(); } catch {}
      pc = null;

      try { if (localStream) localStream.getTracks().forEach(tk => tk.stop()); } catch {}
      localStream = null;

      callActive = false;
      setVoiceState(state || "Idle");
      dbg("");
    }

    $("startVoiceBtn").addEventListener("click", async () => {
      if (!canVoice()) return;
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      if (callActive) return;

      setVoiceState("Requesting");
      unlockAudioNoWait();

      try { await ensureLocalAudio(); }
      catch { setVoiceState("Idle"); return; }

      send("voice_request", {});
    });

    $("stopVoiceBtn").addEventListener("click", () => {
      if (!callActive) return;
      send("voice_stop", {});
      teardownVoice("Stopped");
    });

    function onVoiceRequest() {
      if (!canVoice()) { send("voice_reject", { reason: "not_allowed" }); return; }
      if (callActive) { send("voice_reject", { reason: "busy" }); return; }

      const ok = confirm(t("confirmVoice"));
      if (!ok) { send("voice_reject", { reason: "rejected" }); return; }

      unlockAudioNoWait();
      send("voice_accept", {});
      setVoiceState("Accepted");
    }

    async function onVoiceAccept() {
      try {
        callActive = true;
        setVoiceState("Connecting");

        await createPeer();

        const offer = await pc.createOffer({ offerToReceiveAudio: true });
        await pc.setLocalDescription(offer);

        send("voice_offer", { sdp: offer });
        setVoiceState("Connecting");
      } catch {
        teardownVoice("Voice error");
      }
    }

    function onVoiceReject() {
      callActive = false;
      setVoiceState("Rejected");
    }

    async function onVoiceOffer(msg) {
      try {
        callActive = true;
        setVoiceState("Connecting");

        await createPeer();
        await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        send("voice_answer", { sdp: answer });
        setVoiceState("Connecting");
      } catch {
        teardownVoice("Voice error");
      }
    }

    async function onVoiceAnswer(msg) {
      if (!pc) return;
      try {
        await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
        setVoiceState("Connected");
      } catch {
        teardownVoice("Voice error");
      }
    }

    async function onVoiceIce(msg) {
      if (!pc || !msg || !msg.candidate) return;
      try { await pc.addIceCandidate(new RTCIceCandidate(msg.candidate)); } catch {}
    }

    function onVoiceStop() {
      teardownVoice("Peer stopped");
    }

    /* mobile floating controls map to existing buttons */
    $("fabPen").addEventListener("click", () => $("penBtn").click());
    $("fabEraser").addEventListener("click", () => $("eraserBtn").click());

    function refreshMicFab() {
      $("fabMic").classList.toggle("on", callActive);
    }

    const origSetVoiceState = setVoiceState;
    setVoiceState = function(tState){
      origSetVoiceState(tState);
      refreshMicFab();
    };

    $("fabMic").addEventListener("click", () => {
      if (callActive) $("stopVoiceBtn").click();
      else $("startVoiceBtn").click();
      refreshMicFab();
    });

    async function boot() {
      initLangSwitch();
      syncToolUi();
      await loadIceServers();
      connect();
      updateUi();
      refreshMicFab();
    }

    boot();
  </script>
</body>
</html>
